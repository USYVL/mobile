#!/bin/sh
ds=`date +'%Y-%m-%d %T'`

versionfile=version.php
if [[ $UID -ne 0 ]]; then
  echo "using sudo to run $0"
  sudo $0
fi

fullpath=`which $0`
if [ "$fullpath" ]; then
  echo "fullpath = $fullpath"
  dirn=`dirname $fullpath` 
  cd $dirn
  cd ..
fi

if test ! -d io -o ! -d bin  ; then
  echo "moving up one dir"
  cd ..
  if test ! -d io -o ! -d bin  ; then
    echo "cant seem to find the correct location for this to work"
    exit
  else
    pwd
    echo "seem to have found the right location"
  fi
fi

date=`date +'%Y.%m.%d'`
yfile=`/bin/ls -rt *.php | grep -v version.php | tail -1`
echo "using command to generate: bin/datestamp-from-file $yfile"
date=`bin/datestamp-from-file $yfile`
echo "got the following date string from $yfile: $date"
chmod 644 $versionfile
printf "<?php\n  // version generated by $0 on $ds\n  \$GLOBALS['version'] = '$date';\n?>\n" > $versionfile
chmod 644 $versionfile
